<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Performance Alert List View -->
        <record id="view_performance_alert_list" model="ir.ui.view">
            <field name="name">performance.alert.list</field>
            <field name="model">performance.alert</field>
            <field name="arch" type="xml">
                <list string="Performance Alerts" decoration-danger="severity=='urgent'" decoration-warning="severity=='critical'" decoration-info="severity=='warning'">
                    <field name="create_date"/>
                    <field name="name"/>
                    <field name="alert_type"/>
                    <field name="severity" widget="badge" decoration-info="severity=='info'" decoration-warning="severity=='warning'" decoration-danger="severity=='critical'" decoration-primary="severity=='urgent'"/>
                    <field name="assigned_user_id"/>
                    <field name="age_hours" string="Age (hrs)"/>
                    <field name="state" widget="badge" decoration-muted="state=='dismissed'" decoration-success="state=='resolved'"/>
                    <field name="is_overdue" invisible="1"/>
                    <button name="action_acknowledge" string="Acknowledge" type="object" icon="fa-check" invisible="state != 'new'"/>
                    <button name="action_assign" string="Assign" type="object" icon="fa-user" invisible="state in ('resolved', 'dismissed')"/>
                    <button name="action_resolve" string="Resolve" type="object" icon="fa-check-circle" invisible="state in ('new', 'resolved', 'dismissed')"/>
                </list>
            </field>
        </record>

        <!-- Performance Alert Form View -->
        <record id="view_performance_alert_form" model="ir.ui.view">
            <field name="name">performance.alert.form</field>
            <field name="model">performance.alert</field>
            <field name="arch" type="xml">
                <form string="Performance Alert" class="o_form_view_compact_chatter">
                    <header>
                        <button name="action_acknowledge" string="Acknowledge" type="object" class="btn-primary" invisible="state != 'new'"/>
                        <button name="action_assign" string="Assign" type="object" class="btn-secondary" invisible="state in ('resolved', 'dismissed')"/>
                        <button name="action_resolve" string="Resolve" type="object" class="btn-success" invisible="state in ('new', 'resolved', 'dismissed')"/>
                        <button name="action_dismiss" string="Dismiss" type="object" class="btn-secondary" invisible="state in ('resolved', 'dismissed')"/>
                        <field name="state" widget="statusbar" statusbar_visible="new,acknowledged,in_progress,resolved"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <div class="oe_stat_button" name="age_info">
                                <div class="o_field_widget o_stat_info">
                                    <span class="o_stat_value">
                                        <field name="age_hours" widget="float"/>
                                    </span>
                                    <span class="o_stat_text">Hours Old</span>
                                </div>
                            </div>
                        </div>

                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                        </div>

                        <group>
                            <group>
                                <field name="alert_type"/>
                                <field name="severity" widget="badge"/>
                                <field name="create_date"/>
                            </group>
                            <group>
                                <field name="assigned_user_id"/>
                                <field name="auto_escalate"/>
                                <field name="escalation_hours" invisible="not auto_escalate"/>
                                <field name="is_overdue" invisible="1"/>
                            </group>
                        </group>

                        <group string="Related Records">
                            <group>
                                <field name="kpi_id"/>
                                <field name="programme_id"/>
                            </group>
                            <group>
                                <field name="directorate_id"/>
                                <field name="workflow_id"/>
                            </group>
                        </group>

                        <notebook>
                            <page string="Description">
                                <field name="description" widget="html"/>
                            </page>
                            <page string="Recommended Actions">
                                <field name="recommended_actions" widget="html"/>
                            </page>
                            <page string="Resolution" invisible="state not in ('resolved', 'dismissed')">
                                <group>
                                    <group>
                                        <field name="resolved_by_id"/>
                                        <field name="resolved_date"/>
                                    </group>
                                    <group>
                                        <field name="acknowledged_by_id"/>
                                        <field name="acknowledged_date"/>
                                    </group>
                                </group>
                                <group string="Resolution Notes">
                                    <field name="resolution_notes" nolabel="1"/>
                                </group>
                            </page>
                            <page string="Alert Data" groups="robust_pmis.group_kcca_pmis_admin">
                                <field name="alert_data" widget="ace" options="{'mode': 'json'}"/>
                            </page>
                        </notebook>
                    </sheet>
                    <chatter/>
                </form>
            </field>
        </record>

        <!-- Performance Alert Kanban View -->
        <record id="view_performance_alert_kanban" model="ir.ui.view">
            <field name="name">performance.alert.kanban</field>
            <field name="model">performance.alert</field>
            <field name="arch" type="xml">
                <kanban default_group_by="severity" class="o_kanban_small_column">
                    <field name="name"/>
                    <field name="alert_type"/>
                    <field name="severity"/>
                    <field name="state"/>
                    <field name="assigned_user_id"/>
                    <field name="age_hours"/>
                    <field name="is_overdue"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div t-attf-class="oe_kanban_card oe_kanban_global_click #{record.is_overdue.raw_value ? 'oe_kanban_color_2' : ''}">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <div class="text-muted">
                                            <field name="alert_type"/>
                                        </div>
                                    </div>
                                </div>
                                <div class="o_kanban_record_body">
                                    <div class="text-muted">
                                        Age: <field name="age_hours"/> hours
                                    </div>
                                    <div class="mt8" t-if="record.assigned_user_id.raw_value">
                                        <i class="fa fa-user" title="Assigned User"/> <field name="assigned_user_id"/>
                                    </div>
                                    <div class="mt8">
                                        <span t-attf-class="badge badge-pill badge-#{record.state.raw_value == 'resolved' and 'success' or record.state.raw_value == 'dismissed' and 'secondary' or 'primary'}">
                                            <field name="state"/>
                                        </span>
                                        <span class="badge badge-danger ml8" t-if="record.is_overdue.raw_value">
                                            OVERDUE
                                        </span>
                                    </div>
                                </div>
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <button name="action_acknowledge" type="object" class="btn btn-sm btn-primary" t-if="record.state.raw_value == 'new'">
                                            Acknowledge
                                        </button>
                                        <button name="action_resolve" type="object" class="btn btn-sm btn-success" t-if="record.state.raw_value in ['acknowledged', 'in_progress']">
                                            Resolve
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Alert Assignment Wizard Form -->
        <record id="view_performance_alert_assign_wizard_form" model="ir.ui.view">
            <field name="name">performance.alert.assign.wizard.form</field>
            <field name="model">performance.alert.assign.wizard</field>
            <field name="arch" type="xml">
                <form string="Assign Alert">
                    <group>
                        <field name="alert_id" readonly="1"/>
                        <field name="assigned_user_id"/>
                    </group>
                    <group string="Assignment Notes">
                        <field name="notes" nolabel="1"/>
                    </group>
                    <footer>
                        <button name="action_assign" string="Assign" type="object" class="btn-primary"/>
                        <button string="Cancel" class="btn-secondary" special="cancel"/>
                    </footer>
                </form>
            </field>
        </record>

        <!-- Actions -->
        <record id="action_performance_alert" model="ir.actions.act_window">
            <field name="name">Performance Alerts</field>
            <field name="res_model">performance.alert</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No performance alerts found
                </p>
                <p>
                    Performance alerts notify you of important issues that require attention,
                    such as declining performance, missed targets, or approaching deadlines.
                </p>
            </field>
        </record>

        <record id="action_my_alerts" model="ir.actions.act_window">
            <field name="name">My Alerts</field>
            <field name="res_model">performance.alert</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('assigned_user_id', '=', uid)]</field>
            <field name="context">{'search_default_active': 1}</field>
        </record>

        <record id="action_critical_alerts" model="ir.actions.act_window">
            <field name="name">Critical Alerts</field>
            <field name="res_model">performance.alert</field>
            <field name="view_mode">kanban,list,form</field>
            <field name="domain">[('severity', 'in', ['critical', 'urgent']), ('state', 'not in', ['resolved', 'dismissed'])]</field>
        </record>

        <!-- Search View -->
        <record id="view_performance_alert_search" model="ir.ui.view">
            <field name="name">performance.alert.search</field>
            <field name="model">performance.alert</field>
            <field name="arch" type="xml">
                <search string="Search Alerts">
                    <field name="name"/>
                    <field name="alert_type"/>
                    <field name="assigned_user_id"/>
                    <field name="kpi_id"/>
                    <field name="programme_id"/>
                    <field name="directorate_id"/>
                    
                    <filter string="My Alerts" name="my_alerts" domain="[('assigned_user_id', '=', uid)]"/>
                    <filter string="Unassigned" name="unassigned" domain="[('assigned_user_id', '=', False)]"/>
                    <separator/>
                    <filter string="New" name="new" domain="[('state', '=', 'new')]"/>
                    <filter string="Active" name="active" domain="[('state', 'not in', ['resolved', 'dismissed'])]"/>
                    <filter string="Overdue" name="overdue" domain="[('is_overdue', '=', True)]"/>
                    <separator/>
                    <filter string="Critical" name="critical" domain="[('severity', 'in', ['critical', 'urgent'])]"/>
                    <filter string="Warning" name="warning" domain="[('severity', '=', 'warning')]"/>
                    <separator/>
                    <filter string="Today" name="today" domain="[('create_date', '>=', (context_today()).strftime('%Y-%m-%d 00:00:00'))]"/>
                    <filter string="This Week" name="this_week" domain="[('create_date', '>=', (context_today() - relativedelta(weeks=1)).strftime('%Y-%m-%d 00:00:00'))]"/>
                    
                    <group expand="0" string="Group By">
                        <filter string="Alert Type" name="group_by_alert_type" context="{'group_by': 'alert_type'}"/>
                        <filter string="Severity" name="group_by_severity" context="{'group_by': 'severity'}"/>
                        <filter string="State" name="group_by_state" context="{'group_by': 'state'}"/>
                        <filter string="Assigned To" name="group_by_assigned_user" context="{'group_by': 'assigned_user_id'}"/>
                        <filter string="Directorate" name="group_by_directorate" context="{'group_by': 'directorate_id'}"/>
                        <filter string="Date" name="group_by_date" context="{'group_by': 'create_date'}"/>
                    </group>
                </search>
            </field>
        </record>

    </data>
</odoo>
