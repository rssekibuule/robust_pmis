<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Directorate Performance Graph Views -->

        <!-- Performance Score by Directorate -->
        <record id="view_programme_directorate_rel_graph_performance" model="ir.ui.view">
            <field name="name">programme.directorate.rel.graph.performance</field>
            <field name="model">programme.directorate.rel</field>
            <field name="arch" type="xml">
                <graph string="Directorate KPI Achievement" type="bar">
                    <field name="directorate_id" type="row"/>
                    <field name="normalized_achievement_percent" type="measure"/>
                </graph>
            </field>
        </record>

        <!-- Implementation Status by Directorate -->
        <record id="view_programme_directorate_rel_graph_status" model="ir.ui.view">
            <field name="name">programme.directorate.rel.graph.status</field>
            <field name="model">programme.directorate.rel</field>
            <field name="arch" type="xml">
                <graph string="Implementation Status by Directorate" type="pie">
                    <field name="directorate_id" type="row"/>
                    <field name="implementation_role" type="col"/>
                </graph>
            </field>
        </record>

        <!-- Programme Distribution by Directorate -->
        <record id="view_programme_directorate_rel_graph_distribution" model="ir.ui.view">
            <field name="name">programme.directorate.rel.graph.distribution</field>
            <field name="model">programme.directorate.rel</field>
            <field name="arch" type="xml">
                <graph string="Programme Distribution by Directorate" type="bar">
                    <field name="directorate_id" type="row"/>
                    <field name="programme_id" type="col"/>
                </graph>
            </field>
        </record>

        <!-- Directorate Performance Pivot View -->
        <record id="view_programme_directorate_rel_pivot" model="ir.ui.view">
            <field name="name">programme.directorate.rel.pivot</field>
            <field name="model">programme.directorate.rel</field>
            <field name="arch" type="xml">
                <pivot string="Directorate Performance Analysis">
                    <field name="directorate_id" type="row"/>
                    <field name="programme_id" type="col"/>
                    <field name="normalized_achievement_percent" type="measure"/>
                </pivot>
            </field>
        </record>

        <!-- Directorate Performance Dashboard Kanban -->
        <record id="view_directorate_performance_dashboard" model="ir.ui.view">
            <field name="name">directorate.performance.dashboard</field>
            <field name="model">programme.directorate.rel</field>
            <field name="arch" type="xml">
                <kanban class="o_kanban_dashboard o_directorate_dashboard" default_group_by="directorate_id">
                    <field name="directorate_id"/>
                    <field name="programme_id"/>
                    <!-- Ensure programme_name is loaded for use in template -->
                    <field name="programme_name"/>
                    <field name="implementation_role"/>
                    <field name="normalized_achievement_percent"/>
                    <!-- Load KPI counts for smarter metrics on cards -->
                    <field name="owned_indicator_count"/>
                    <field name="all_indicator_count"/>

                    <field name="responsibility_percentage"/>
                    <field name="active"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="o_kanban_record">
                                <div class="o_kanban_content">
                                    <div class="row">
                                        <div class="col-6">
                                            <strong><field name="programme_name"/></strong>
                                        </div>
                                        <div class="col-6 text-right">
                                            <span t-attf-class="badge #{record.implementation_role.raw_value == 'primary' ? 'badge-success' :
                                                                       record.implementation_role.raw_value == 'supporting' ? 'badge-warning' :
                                                                       record.implementation_role.raw_value == 'coordinating' ? 'badge-info' : 'badge-secondary'}">
                                                <field name="implementation_role"/>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <div class="progress" style="height: 10px;">
                                                <div class="progress-bar" role="progressbar"
                                                     t-attf-style="width: #{record.normalized_achievement_percent.raw_value}%"
                                                     t-attf-class="#{record.normalized_achievement_percent.raw_value >= 80 ? 'bg-success' :
                                                                     record.normalized_achievement_percent.raw_value >= 50 ? 'bg-warning' : 'bg-danger'}">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2 align-items-center">
                                        <div class="col-8">
                                            <span class="badge badge-light" title="Owned KPIs / All Programme KPIs">
                                                KPIs: <t t-esc="record.owned_indicator_count.raw_value"/>/<t t-esc="record.all_indicator_count.raw_value"/>
                                            </span>
                                        </div>
                                        <div class="col-4 text-right">
                                            <field name="active" widget="boolean_toggle"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>

        <!-- Directorate Performance Dashboard Action -->
        <record id="action_directorate_performance_dashboard" model="ir.actions.act_window">
            <field name="name">Directorate Performance Dashboard</field>
            <field name="res_model">programme.directorate.rel</field>
            <field name="view_mode">kanban,form,graph,pivot,list</field>
            <field name="view_ids" eval="[(5, 0, 0),
                                          (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_directorate_performance_dashboard')}),
                                          (0, 0, {'view_mode': 'form', 'view_id': ref('view_programme_directorate_rel_form')}),
                                          (0, 0, {'view_mode': 'graph', 'view_id': ref('view_programme_directorate_rel_graph_performance')}),
                                          (0, 0, {'view_mode': 'pivot', 'view_id': ref('view_programme_directorate_rel_pivot')}),
                                          (0, 0, {'view_mode': 'list', 'view_id': ref('view_programme_directorate_rel_tree')})]"/>
            <!-- Explicitly set search view to avoid auto-generated searchpanel trying to use integer fields as categories -->
            <field name="search_view_id" ref="robust_pmis.view_programme_directorate_rel_search"/>
            <field name="context">{
                'search_default_active': 1,
                'search_default_group_by_directorate': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Directorate Performance Dashboard
                </p>
                <p>
                    Monitor and analyze the performance of programmes implemented by each directorate.
                    Track implementation roles, responsibility percentages, and overall performance metrics.
                </p>
            </field>
        </record>

        <!-- Directorate Performance Analytics Action -->
        <record id="action_directorate_performance_analytics" model="ir.actions.act_window">
            <field name="name">Directorate Performance Analytics</field>
            <field name="res_model">programme.directorate.rel</field>
            <field name="view_mode">pivot,graph,list</field>
            <field name="view_ids" eval="[(5, 0, 0),
                                          (0, 0, {'view_mode': 'pivot', 'view_id': ref('view_programme_directorate_rel_pivot')}),
                                          (0, 0, {'view_mode': 'graph', 'view_id': ref('view_programme_directorate_rel_graph_performance')}),
                                          (0, 0, {'view_mode': 'list', 'view_id': ref('view_programme_directorate_rel_tree')})]"/>
            <field name="search_view_id" ref="robust_pmis.view_programme_directorate_rel_search"/>
            <field name="context">{
                'search_default_active': 1,
                'pivot_measures': ['normalized_achievement_percent'],
                'pivot_row_groupby': ['directorate_id'],
                'pivot_col_groupby': ['programme_id']
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Advanced Directorate Analytics
                </p>
                <p>
                    Perform detailed analysis of directorate performance across programmes.
                    Use pivot tables and charts to identify trends and patterns.
                </p>
            </field>
        </record>

        <!-- Directorate Budget Performance Action -->
        <record id="action_directorate_budget_performance" model="ir.actions.act_window">
            <field name="name">Directorate Budget Performance</field>
            <field name="res_model">programme.directorate.rel</field>
            <field name="view_mode">pivot,graph,list</field>
            <field name="view_ids" eval="[(5, 0, 0),
                                          (0, 0, {'view_mode': 'pivot', 'view_id': ref('view_programme_directorate_rel_pivot')}),
                                          (0, 0, {'view_mode': 'graph', 'view_id': ref('view_programme_directorate_rel_graph_performance')}),
                                          (0, 0, {'view_mode': 'list', 'view_id': ref('view_programme_directorate_rel_tree')})]"/>
            <field name="search_view_id" ref="robust_pmis.view_programme_directorate_rel_search"/>
            <field name="context">{
                'search_default_active': 1,
                'search_default_group_by_directorate': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Directorate Budget Performance
                </p>
                <p>
                    Monitor budget allocation and utilization across directorates and programmes.
                    Track financial performance and resource efficiency.
                </p>
            </field>
        </record>

        <!-- Directorate Impact Analysis Action -->
        <record id="action_directorate_impact_analysis" model="ir.actions.act_window">
            <field name="name">Directorate Impact Analysis</field>
            <field name="res_model">programme.directorate.rel</field>
            <field name="view_mode">graph,pivot,list</field>
            <field name="view_ids" eval="[(5, 0, 0),
                                          (0, 0, {'view_mode': 'graph', 'view_id': ref('view_programme_directorate_rel_graph_distribution')}),
                                          (0, 0, {'view_mode': 'pivot', 'view_id': ref('view_programme_directorate_rel_pivot')}),
                                          (0, 0, {'view_mode': 'list', 'view_id': ref('view_programme_directorate_rel_tree')})]"/>
            <field name="search_view_id" ref="robust_pmis.view_programme_directorate_rel_search"/>
            <field name="context">{
                'search_default_active': 1,
                'search_default_group_by_implementation_role': 1
            }</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Directorate Impact Analysis
                </p>
                <p>
                    Analyze the impact and effectiveness of directorate programme implementation.
                    Evaluate outcomes and strategic alignment.
                </p>
            </field>
        </record>

    </data>
</odoo>
